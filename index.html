<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Kiki - Camera System Finder</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #fff;
        }
        .container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        .logo {
            font-size: 64px;
            margin-bottom: 10px;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .subtitle {
            color: rgba(255,255,255,0.7);
            margin-bottom: 30px;
        }
        .status {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: #4ade80;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-text {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .found {
            display: none;
        }
        .found.show {
            display: block;
        }
        .found-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .found h2 {
            color: #4ade80;
            margin-bottom: 8px;
        }
        .ip-note {
            font-size: 15px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 30px;
        }
        .ip-note strong {
            color: #fff;
            font-family: monospace;
            background: rgba(0,0,0,0.3);
            padding: 5px 12px;
            border-radius: 5px;
            user-select: all;
        }
        .access-section {
            margin-bottom: 30px;
        }
        .access-label {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 10px;
        }
        .url-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .device-url {
            background: rgba(0,0,0,0.3);
            padding: 15px 20px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 18px;
            word-break: break-all;
            flex: 1;
            max-width: 300px;
        }
        .copy-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            padding: 12px 14px;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .copy-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        .bookmark-note {
            margin-top: 12px;
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            font-style: italic;
        }
        .open-btn {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 10px;
        }
        .open-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(74,222,128,0.3);
        }
        .copied-msg {
            font-size: 13px;
            color: #4ade80;
            opacity: 0;
            transition: opacity 0.3s;
            height: 20px;
        }
        .copied-msg.show {
            opacity: 1;
        }
        .error {
            display: none;
        }
        .error.show {
            display: block;
        }
        .error-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .error h2 {
            color: #f87171;
            margin-bottom: 10px;
        }
        .error p {
            color: rgba(255,255,255,0.7);
            margin-bottom: 15px;
            line-height: 1.6;
        }
        .retry-btn {
            background: rgba(255,255,255,0.2);
            color: #fff;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .retry-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .manual-ip {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .manual-ip input {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 15px;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            width: 180px;
            margin-right: 10px;
        }
        .manual-ip input::placeholder {
            color: rgba(255,255,255,0.4);
        }
        .manual-ip button {
            background: rgba(255,255,255,0.2);
            color: #fff;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }
        .scanning {
            display: block;
        }
        .scanning.hide {
            display: none;
        }
        .tips {
            margin-top: 30px;
            text-align: left;
            font-size: 13px;
            color: rgba(255,255,255,0.5);
        }
        .tips h4 {
            color: rgba(255,255,255,0.7);
            margin-bottom: 10px;
        }
        .tips ul {
            padding-left: 20px;
        }
        .tips li {
            margin-bottom: 5px;
        }
        .intro {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            line-height: 1.5;
        }
        .intro strong {
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">&#x1F3A5;</div>
        <h1>Find Kiki</h1>
        <p class="subtitle">Camera System Finder</p>

        <div class="scanning" id="scanning">
            <div class="intro">
                Make sure you're connected to <strong>the same WiFi network</strong> as your Kiki device.
            </div>
            <div class="status">
                <div class="spinner"></div>
                <div class="status-text" id="statusText">Initializing...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>

        <div class="found" id="found">
            <div class="found-icon">&#x2705;</div>
            <h2>Device Found!</h2>
            <p class="ip-note">IP address: <strong id="deviceIp"></strong></p>

            <div class="access-section">
                <p class="access-label">Your Kiki Camera System:</p>
                <div class="url-row">
                    <div class="device-url" id="deviceUrl"></div>
                    <button class="copy-btn" onclick="copyUrl()" title="Copy to clipboard">&#x1F4CB;</button>
                </div>
                <p class="bookmark-note">&#x1F516; Bookmark this address for easy access</p>
            </div>

            <button class="open-btn" onclick="openDevice()">Open Kiki</button>
            <p class="copied-msg" id="copiedMsg">Copied!</p>
        </div>

        <div class="error" id="error">
            <div class="error-icon">&#x26A0;&#xFE0F;</div>
            <h2>Device Not Found</h2>
            <p>Could not find Kiki on your network. Make sure the device is powered on and connected to the same WiFi network.</p>
            <button class="retry-btn" onclick="startScan()">Try Again</button>

            <div class="manual-ip">
                <p style="margin-bottom: 10px; font-size: 14px;">Or enter the IP address manually:</p>
                <input type="text" id="manualIp" placeholder="192.168.1.xxx">
                <button onclick="tryManualIp()">Connect</button>
            </div>

            <div class="tips">
                <h4>Troubleshooting:</h4>
                <ul>
                    <li><strong>Disable VPN</strong> - VPNs block local network access</li>
                    <li>Make sure you're on your home WiFi (not mobile data)</li>
                    <li>Check that Kiki is powered on</li>
                    <li>Wait 30 seconds after Kiki restarts, then try again</li>
                    <li>Check your router's admin page for a device named "kiki"</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let foundUrl = '';

        async function checkDevice(url) {
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 2000);

                const response = await fetch(url + '/discover', {
                    signal: controller.signal,
                    mode: 'cors'
                });
                clearTimeout(timeout);

                if (response.ok) {
                    const data = await response.json();
                    if (data.device === 'Kiki') {
                        return true;
                    }
                }
            } catch (e) {
                // Connection failed or timed out
            }
            return false;
        }

        async function startScan() {
            document.getElementById('scanning').classList.remove('hide');
            document.getElementById('found').classList.remove('show');
            document.getElementById('error').classList.remove('show');

            const statusText = document.getElementById('statusText');
            const progressFill = document.getElementById('progressFill');

            // Step 1: Try mDNS name first
            statusText.textContent = 'Trying kiki.local...';
            progressFill.style.width = '5%';

            if (await checkDevice('http://kiki.local:5000')) {
                showFound('http://kiki.local:5000');
                return;
            }

            // Step 2: Try common private IP ranges
            statusText.textContent = 'Scanning network...';

            let subnets = ['192.168.1', '192.168.0', '192.168.2', '10.0.0', '10.0.1', '172.16.0'];

            // Common IPs to try first
            const commonEndings = [1, 2, 100, 101, 102, 103, 104, 105, 110, 120, 130, 140, 142, 150, 200, 234, 250, 10, 11, 12, 13, 14, 15, 20, 21, 22, 25, 30, 40, 50];

            let checked = 0;
            const totalChecks = subnets.length * commonEndings.length + subnets.length * 50;

            // Try common IPs first (faster)
            for (const subnet of subnets) {
                for (const end of commonEndings) {
                    const ip = `${subnet}.${end}`;
                    statusText.textContent = `Checking ${ip}...`;
                    checked++;
                    progressFill.style.width = Math.min(50, (checked / totalChecks) * 100) + '%';

                    if (await checkDevice(`http://${ip}:5000`)) {
                        showFound(`http://${ip}:5000`);
                        return;
                    }
                }
            }

            // Broader scan - check more IPs in parallel
            statusText.textContent = 'Deep scanning...';

            for (const subnet of subnets.slice(0, 3)) {
                const batchSize = 10;
                for (let start = 2; start <= 254; start += batchSize) {
                    const promises = [];
                    for (let i = start; i < Math.min(start + batchSize, 255); i++) {
                        if (!commonEndings.includes(i)) {
                            const ip = `${subnet}.${i}`;
                            promises.push(
                                checkDevice(`http://${ip}:5000`).then(found => found ? ip : null)
                            );
                        }
                    }

                    checked += batchSize;
                    progressFill.style.width = Math.min(95, 50 + (checked / totalChecks) * 50) + '%';
                    statusText.textContent = `Scanning ${subnet}.${start}-${Math.min(start + batchSize - 1, 254)}...`;

                    const results = await Promise.all(promises);
                    const found = results.find(r => r !== null);
                    if (found) {
                        showFound(`http://${found}:5000`);
                        return;
                    }
                }
            }

            // Not found
            progressFill.style.width = '100%';
            showError();
        }

        function showFound(url) {
            foundUrl = url;
            document.getElementById('scanning').classList.add('hide');
            document.getElementById('found').classList.add('show');
            document.getElementById('deviceUrl').textContent = url;

            const urlObj = new URL(url);
            const host = urlObj.hostname;
            if (/^\d+\.\d+\.\d+\.\d+$/.test(host)) {
                document.getElementById('deviceIp').textContent = host;
            } else {
                document.getElementById('deviceIp').textContent = host;
                // Try to find numeric IP in background
                findIpAddress().then(ip => {
                    if (ip) document.getElementById('deviceIp').textContent = ip;
                });
            }
        }

        async function findIpAddress() {
            const subnets = ['192.168.1', '192.168.0', '192.168.2', '10.0.0'];
            const commonEndings = [1, 100, 101, 102, 142, 200, 234, 250, 2, 10, 50];
            for (const subnet of subnets) {
                for (const end of commonEndings) {
                    const ip = `${subnet}.${end}`;
                    try {
                        const controller = new AbortController();
                        const timeout = setTimeout(() => controller.abort(), 500);
                        const response = await fetch(`http://${ip}:5000/discover`, {
                            signal: controller.signal,
                            mode: 'cors'
                        });
                        clearTimeout(timeout);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.device === 'Kiki') return ip;
                        }
                    } catch (e) {}
                }
            }
            return null;
        }

        function showError() {
            document.getElementById('scanning').classList.add('hide');
            document.getElementById('error').classList.add('show');
        }

        function openDevice() {
            window.location.href = foundUrl;
        }

        function copyUrl() {
            navigator.clipboard.writeText(foundUrl).then(() => {
                const msg = document.getElementById('copiedMsg');
                msg.classList.add('show');
                setTimeout(() => msg.classList.remove('show'), 2000);
            }).catch(() => {
                const input = document.createElement('input');
                input.value = foundUrl;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                const msg = document.getElementById('copiedMsg');
                msg.classList.add('show');
                setTimeout(() => msg.classList.remove('show'), 2000);
            });
        }

        async function tryManualIp() {
            const ip = document.getElementById('manualIp').value.trim();
            if (!ip) {
                alert('Please enter an IP address');
                return;
            }

            let url = ip.startsWith('http') ? ip : `http://${ip}`;
            if (!url.includes(':5000') && !url.match(/:\d+$/)) {
                url = url + ':5000';
            }

            document.getElementById('error').classList.remove('show');
            document.getElementById('scanning').classList.remove('hide');
            document.getElementById('statusText').textContent = `Checking ${url}...`;
            document.getElementById('progressFill').style.width = '50%';

            if (await checkDevice(url)) {
                showFound(url);
            } else {
                if (confirm(`Could not verify Kiki at ${url}.\n\nOpen it anyway?`)) {
                    window.location.href = url;
                } else {
                    showError();
                }
            }
        }

        // Start scanning on page load
        window.onload = startScan;
    </script>
</body>
</html>
